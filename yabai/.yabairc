#!/usr/bin/env sh

exit_native_fullscreen_windows() {
  echo "Exiting native fullscreen windows..."
  for win_id in $(yabai -m query --windows | jq '.[] | select(.["is-native-fullscreen"] == true) | .id'); do
    echo "Exiting native fullscreen for window: $win_id"
    yabai -m window "$win_id" --toggle native-fullscreen
  done
}

setup_spaces_with_labels() {
  echo "Setting up spaces..."
  desired=$#
  current=$(yabai -m query --spaces | jq 'length')

  # First, create spaces until we have the desired count
  while [ "$current" -lt "$desired" ]; do
    idx=$((current + 1))
    echo "Creating space $idx"
    yabai -m space --create
    current=$((current + 1))
  done

  # Then, label each space according to the provided names
  idx=0
  for name in "$@"; do
    idx=$((idx + 1))
    echo "Labeling space $idx: $name"
    yabai -m space "$idx" --label "$name"
  done
}

destroy_spaces_beyond_max() {
  max="$1"
  echo "Destroying spaces beyond max: $max"
  for _ in $(yabai -m query --spaces | jq '.[].index | select(. > '"$max"')'); do
    yabai -m space --destroy $((max + 1))
  done
}

#
# for this to work you must configure sudo such that
# it will be able to run the command without password
#
# see this wiki page for information:
#  - https://github.com/koekeishiya/yabai/wiki/Installing-yabai-(latest-release)#configure-scripting-addition
#
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
sudo yabai --load-sa

# global settings
yabai -m config                                 \
    external_bar                 off:40:0       \
    menubar_opacity              1.0            \
    mouse_follows_focus          on            \
    focus_follows_mouse          off            \
    display_arrangement_order    default        \
    window_origin_display        default        \
    window_placement             second_child   \
    window_insertion_point       focused        \
    window_zoom_persist          on             \
    window_shadow                off            \
    window_animation_duration    0.0            \
    window_animation_easing      ease_out_circ  \
    window_opacity_duration      0.0            \
    active_window_opacity        1.0            \
    normal_window_opacity        0.90           \
    window_opacity               off            \
    insert_feedback_color        0xffd75f5f     \
    split_ratio                  0.50           \
    split_type                   auto           \
    auto_balance                 off            \
    top_padding                  0             \
    bottom_padding               1             \
    left_padding                 1             \
    right_padding                1             \
    window_gap                   1             \
    layout                       bsp            \
    mouse_modifier               fn             \
    mouse_action1                move           \
    mouse_action2                resize         \
    mouse_drop_action            swap



spaces="terminal code web work social other"
set -- $spaces
max_spaces=$#

# Ensure no windows are in native fullscreen (cannot manage/destroy those spaces otherwise)
exit_native_fullscreen_windows

# Force to have only the number of spaces defined in the array
destroy_spaces_beyond_max "$max_spaces"

# Setup spaces using the list
setup_spaces_with_labels $spaces

# App assignments
echo "Configuring app assignments..."

# Terminal apps
yabai -m rule --add app="^iTerm$" space="terminal"
yabai -m rule --add app="^kitty$" space="terminal"

# Code editors
yabai -m space "code" --layout stack
yabai -m rule --add app="^Cursor$" space="code"
yabai -m rule --add app="^Postman$" space="code"

# Web browsers
yabai -m space "web" --layout stack
yabai -m rule --add app="^Brave Browser$" space="web"

# Social and communication apps
yabai -m rule --add app="^(Telegram|WhatsApp|Discord)$" space="social"
yabai -m rule --add app="WhatsApp" space="social"

# Work apps
yabai -m rule --add app="^Fantastical$" space="work"
yabai -m rule --add app="^(Slack|Zoom)$" space="work"

# Media and entertainment
yabai -m rule --add app="^(Music|Spotify)$" space="other"

echo "Configuring non-managed apps..."
yabai -m rule --add app="^System Preferences$" sticky=on sub-layer=above manage=off
yabai -m rule --add app="^System Settings$" sticky=on sub-layer=above manage=off
yabai -m rule --add app="^Finder$" manage=off sticky=on sub-layer=above
yabai -m rule --add app="^1Password$" manage=off sticky=on sub-layer=above
yabai -m rule --add app="^System Information$" sticky=on sub-layer=above manage=off
yabai -m rule --add app="^TeamViewer$" sticky=off sub-layer=above manage=off
yabai -m rule --add title='Settings$' manage=off sub-layer=above sticky=on
yabai -m rule --add title="^Preferences$" manage=off sub-layer=above sticky=on
yabai -m rule --add app="CleanShootX" manage=off sub-layer=above sticky=on
yabai -m rule --add app="Raycast" manage=off sub-layer=above sticky=on
yabai -m rule --add app="VeraCrypt" manage=off sub-layer=above sticky=on
yabai -m rule --add app="^Brave Browser$" title="(MetaMask|Phantom Wallet)" sub-layer=above manage=off sticky=on
yabai -m rule --add app="^Brave Browser$" title="Sign In" manage=off sub-layer=above sticky=on
yabai -m rule --add app="^Google Chrome for Testing$" manage=off
yabai -m rule --add app="^IINA$" manage=off sub-layer=above
yabai -m rule --add app="^Docker Desktop$" manage=off sub-layer=above


# borders \
#   "active_color=gradient(top_left=0xFF45c4c0,bottom_right=0xFFba3aa5)" \
#   "inactive_color=0x00RRGGBB" \
#   width=2

borders \
  "active_color=gradient(top_left=0xee33ccff,bottom_right=0xee00ff99)" \
  "inactive_color=0xaa595959" \
  width=2 &

echo "Applying rules..."
yabai -m rule --apply